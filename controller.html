<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kinemon - Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: white;
            touch-action: none;
        }

        #container {
            width: 100%;
            max-width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .screen {
            display: none;
            max-width: 500px;
            width: 100%;
        }

        .screen.active {
            display: block;
        }

        h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 32px;
            margin-bottom: 20px;
        }

        p {
            font-size: 18px;
            margin-bottom: 30px;
            opacity: 0.8;
            line-height: 1.6;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            display: inline-block;
            min-width: 200px;
        }

        .btn:active {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:active {
            background: #0b7dda;
        }

        .btn-danger {
            background: #F44336;
        }

        .btn-danger:active {
            background: #da190b;
        }

        input {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid #4CAF50;
            padding: 15px;
            font-size: 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
        }

        .status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #F44336;
        }

        .calibration-indicator {
            font-size: 64px;
            margin: 20px 0;
        }

        .instruction {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .tilt-display {
            font-size: 48px;
            font-weight: bold;
            color: #4CAF50;
            margin: 20px 0;
        }

        .info {
            font-size: 14px;
            opacity: 0.6;
            margin-top: 20px;
        }

        #qrReader {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }

        #qrReader video {
            width: 100%;
            border-radius: 10px;
        }

        .room-display {
            font-size: 36px;
            font-weight: bold;
            color: #4CAF50;
            letter-spacing: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Room Input Screen -->
        <div id="roomInputScreen" class="screen active">
            <h1>üì± –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä</h1>
            <p>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–µ</p>

            <button class="btn" id="scanQrBtn">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</button>
            <p style="font-size: 14px; opacity: 0.5;">–∏–ª–∏</p>

            <input type="text" id="roomIdInput" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: ABC123)" maxlength="6" style="text-transform: uppercase;">
            <br>
            <input type="text" id="playerName" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" value="Player">
            <br>
            <input type="text" id="serverUrl" placeholder="–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞" value="">
            <br>
            <button class="btn btn-secondary" id="manualJoinBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <!-- QR Scanner Screen removed - now using native camera app -->

        <!-- Calibration Min Screen -->
        <div id="calibrationMinScreen" class="screen">
            <h2>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h2>
            <div class="room-display">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomDisplay1"></span></div>
            <div class="calibration-indicator">‚¨áÔ∏è</div>
            <div class="instruction">
                <p><strong>–®–∞–≥ 1 –∏–∑ 2</strong></p>
                <p>–ù–∞–∫–ª–æ–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ø–æ–ª–æ–∂–µ–Ω–∏–µ<br>–¥–ª—è –ù–ò–ñ–ù–ï–ô –ø–æ–∑–∏—Ü–∏–∏</p>
            </div>
            <button id="setMinBtn" class="btn">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <!-- Calibration Max Screen -->
        <div id="calibrationMaxScreen" class="screen">
            <h2>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h2>
            <div class="room-display">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomDisplay2"></span></div>
            <div class="calibration-indicator">‚¨ÜÔ∏è</div>
            <div class="instruction">
                <p><strong>–®–∞–≥ 2 –∏–∑ 2</strong></p>
                <p>–ù–∞–∫–ª–æ–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ø–æ–ª–æ–∂–µ–Ω–∏–µ<br>–¥–ª—è –í–ï–†–•–ù–ï–ô –ø–æ–∑–∏—Ü–∏–∏</p>
            </div>
            <button id="setMaxBtn" class="btn">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <!-- Controller Screen -->
        <div id="controllerScreen" class="screen">
            <h2>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <div class="room-display">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomDisplay3"></span></div>
            <div id="statusDisplay" class="status connected">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
            <div class="tilt-display" id="tiltDisplay">0.50</div>
            <p>–ù–∞–∫–ª–æ–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <div class="info">
                <p id="playerInfo">–ò–≥—Ä–æ–∫: <span id="playerNameDisplay"></span></p>
            </div>
            <button class="btn btn-danger" id="disconnectBtn">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <script src="motionController.js"></script>
    <script src="calibration.js"></script>
    <script>
        let ws = null;
        let motionController = null;
        let calibration = null;
        let playerId = null;
        let roomId = null;

        const roomInputScreen = document.getElementById('roomInputScreen');
        const calibrationMinScreen = document.getElementById('calibrationMinScreen');
        const calibrationMaxScreen = document.getElementById('calibrationMaxScreen');
        const controllerScreen = document.getElementById('controllerScreen');

        const playerNameInput = document.getElementById('playerName');
        const roomIdInput = document.getElementById('roomIdInput');
        const serverUrlInput = document.getElementById('serverUrl');
        const scanQrBtn = document.getElementById('scanQrBtn');
        const manualJoinBtn = document.getElementById('manualJoinBtn');
        const setMinBtn = document.getElementById('setMinBtn');
        const setMaxBtn = document.getElementById('setMaxBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDisplay = document.getElementById('statusDisplay');
        const tiltDisplay = document.getElementById('tiltDisplay');
        const playerNameDisplay = document.getElementById('playerNameDisplay');

        // Set default server URL based on current location
        // For production, use your deployed server URL (e.g., wss://kinemon-games.onrender.com)
        // For local testing, use ws://localhost:8080
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';
        const defaultServer = isLocalhost ? 'ws://localhost:8080' : 'wss://kinemon-games.onrender.com';
        serverUrlInput.value = defaultServer;

        // Check URL parameters (from QR code scan)
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        const serverFromUrl = urlParams.get('server');

        if (roomFromUrl && serverFromUrl) {
            console.log('Detected QR code parameters:', {room: roomFromUrl, server: serverFromUrl});
            // Auto-fill fields
            roomIdInput.value = roomFromUrl;
            serverUrlInput.value = serverFromUrl;

            // Auto-connect after a short delay
            setTimeout(() => {
                connectToRoom(roomFromUrl, serverFromUrl);
            }, 500);
        }

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

            if (screenName === 'room-input') {
                roomInputScreen.classList.add('active');
            } else if (screenName === 'calibration-min') {
                calibrationMinScreen.classList.add('active');
            } else if (screenName === 'calibration-max') {
                calibrationMaxScreen.classList.add('active');
            } else if (screenName === 'controller') {
                controllerScreen.classList.add('active');
            }
        }

        function updateRoomDisplay(room) {
            document.getElementById('roomDisplay1').textContent = room;
            document.getElementById('roomDisplay2').textContent = room;
            document.getElementById('roomDisplay3').textContent = room;
        }

        // QR Scanner (now using built-in camera app)
        scanQrBtn.addEventListener('click', () => {
            alert('üì± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é:\n\n1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ\n2. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥\n3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ—è–≤–∏–≤—à–µ–µ—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —ç—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏!\n\n–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ.');
        });

        // Cancel scan button removed - now using native camera

        // Manual join
        manualJoinBtn.addEventListener('click', () => {
            const room = roomIdInput.value.trim().toUpperCase();
            const server = serverUrlInput.value.trim();

            if (!room) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }

            connectToRoom(room, server);
        });

        async function connectToRoom(room, serverUrl) {
            roomId = room;
            updateRoomDisplay(roomId);

            try {
                // Connect to WebSocket server
                ws = new WebSocket(serverUrl);

                ws.onopen = async () => {
                    console.log('Connected to server');

                    // Initialize motion controller
                    motionController = new MotionController();
                    calibration = new Calibration(motionController);

                    // Request permission and start calibration
                    await motionController.requestPermission();
                    motionController.start();
                    await calibration.start();

                    showScreen('calibration-min');
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    showScreen('room-input');
                };

                ws.onclose = () => {
                    console.log('Disconnected from server');
                    statusDisplay.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    statusDisplay.className = 'status disconnected';
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.type === 'init') {
                        playerId = data.playerId;
                        console.log('Received player ID:', playerId);
                    }
                };
            } catch (error) {
                console.error('Connection error:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
                showScreen('room-input');
            }
        }

        setMinBtn.addEventListener('click', () => {
            calibration.setMinPosition();
            showScreen('calibration-max');
        });

        setMaxBtn.addEventListener('click', () => {
            calibration.setMaxPosition();
        });

        calibration.onComplete = (min, max) => {
            console.log('Calibration complete:', min, max);

            // Send join message
            ws.send(JSON.stringify({
                type: 'join',
                roomId: roomId,
                name: playerNameInput.value.trim() || 'Player'
            }));

            playerNameDisplay.textContent = playerNameInput.value.trim() || 'Player';
            showScreen('controller');

            // Start sending tilt data
            motionController.onTiltChange = (normalized) => {
                tiltDisplay.textContent = normalized.toFixed(2);

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'input',
                        tilt: normalized
                    }));
                }
            };
        };

        disconnectBtn.addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
            if (motionController) {
                motionController.stop();
            }
            showScreen('room-input');
        });
    </script>
</body>
</html>
